---
last_mapped: 2026-01-29T06:58:00Z
scanner_version: 2.0.1
report_version: 2.1.0
total_files: 33
total_tokens: 40268
coverage:
  files_analyzed: 27/33
  tokens_analyzed: 40268/40268
  excluded_paths: []
---

# Recon Report

> Auto-generated by Recon. Last mapped: 2026-01-29

## System Overview

```mermaid
graph TB
    subgraph Client["AI Assistant (Claude/Cursor/Codex)"]
        MCP[MCP Protocol]
    end

    subgraph Probe["Probe MCP Server"]
        CLI[CLI]
        Server[MCP Server]
        Retrieval[Retrieval Pipeline]
        Indexing[Indexing Pipeline]
        Chunking[Chunking]
    end

    subgraph Storage["Storage Layer"]
        Qdrant[(Qdrant Vectors)]
        SQLite[(SQLite Manifest)]
    end

    subgraph Services["Backend Services"]
        TEI[TEI Embeddings]
        Reranker[Reranker]
    end

    MCP --> Server
    CLI --> Server
    Server --> Retrieval
    Retrieval --> Qdrant
    Retrieval --> TEI
    Retrieval --> Reranker
    Indexing --> Chunking
    Indexing --> TEI
    Indexing --> Qdrant
    Indexing --> SQLite
```

Probe is an MCP server providing semantic code search for AI assistants. It indexes codebases using text embeddings (TEI), stores vectors in Qdrant, and supports hybrid dense+sparse retrieval with optional cross-encoder reranking.

## Entrypoints

| Entry | Type | Evidence |
|-------|------|----------|
| [probe/cli.py](probe/cli.py) | pyproject.toml scripts | `probe = "probe.cli:app"` |
| [probe/__main__.py](probe/__main__.py) | module execution | `python -m probe` |
| [probe/server.py](probe/server.py) | MCP server | Started via `probe serve` |

## Config Surface

| Category | Files |
|----------|-------|
| Package | [pyproject.toml](pyproject.toml), [services/reranker/requirements.txt](services/reranker/requirements.txt) |
| Docker | [deploy/docker-compose.yml](deploy/docker-compose.yml), [services/reranker/Dockerfile](services/reranker/Dockerfile) |
| Linting | [pyproject.toml](pyproject.toml) (ruff + mypy config) |
| MCP | [.mcp.json.example](.mcp.json.example) |

## Environment Surface

| Variable | Used In | Required |
|----------|---------|----------|
| QDRANT_URL | config.py | No (default: http://127.0.0.1:6333) |
| TEI_EMBED_URL | config.py | No (default: http://127.0.0.1:8080) |
| RERANKER_URL | config.py | No (auto-enabled for balanced/pro) |
| PROBE_PRESET | config.py | No (default: lite) |
| MODEL_ID | services/reranker/main.py | No (default: Qwen3-Reranker-0.6B) |
| HOST | services/reranker/main.py | No (default: 127.0.0.1) |
| PORT | services/reranker/main.py | No (default: 8083) |
| TEI_IMAGE_TAG | docker-compose.yml | No (default: ghcr.io/huggingface/text-embeddings-inference:1.8) |

## API Surface

### MCP Tools

| Tool | Description | Parameters |
|------|-------------|------------|
| `search` | Semantic code search | query, top_k, mode, instruction, filters |
| `open_file` | Read file lines with sandbox validation | path, start_line, end_line |
| `index_status` | Get indexing health stats | none |

### CLI Commands

| Command | Description | Status |
|---------|-------------|--------|
| `probe init [PATH]` | Initialize workspace | Implemented |
| `probe serve [PATH]` | Start MCP server | Implemented |
| `probe scan [PATH]` | Trigger full index scan | Implemented |
| `probe prune` | Remove stale workspaces | Stub |
| `probe doctor` | Health checks | Stub |

### HTTP Endpoints (Reranker Service)

| Method | Path | Description |
|--------|------|-------------|
| POST | /rerank | Rerank documents by relevance |
| GET | /health | Health check |

## Test Coverage

| Module | Test File | Coverage |
|--------|-----------|----------|
| probe/cli.py | tests/test_cli.py | Commands tested |
| probe/config.py | tests/test_config.py | Config loading tested |
| probe/server.py | tests/test_server.py | open_file tested |
| probe/storage/manifest.py | tests/test_storage.py | CRUD operations tested |
| probe/chunking/ | tests/test_chunking.py | Detection + chunking tested |
| probe/retrieval.py | - | No tests |
| probe/indexing.py | - | No tests |
| probe/storage/qdrant.py | - | No tests |
| services/reranker/ | - | No tests |

## Directory Structure

```
probe/
├── __init__.py          # Package init, version
├── __main__.py          # Module entry point
├── cli.py               # Typer CLI commands
├── config.py            # Configuration loading
├── types.py             # Pydantic models (Chunk, SearchResult, etc.)
├── server.py            # MCP server implementation
├── retrieval.py         # Search pipeline (embed → search → rerank)
├── indexing.py          # Index pipeline (scan → chunk → embed → store)
├── chunking/
│   ├── __init__.py      # Strategy dispatcher
│   ├── text.py          # Markdown + line-based fallback
│   └── tree_sitter.py   # AST-aware code chunking
└── storage/
    ├── __init__.py      # Module exports
    ├── manifest.py      # SQLite file/chunk tracking
    └── qdrant.py        # Vector database client

services/
└── reranker/
    ├── main.py          # FastAPI reranker service
    ├── Dockerfile       # Container build
    └── requirements.txt # Dependencies

deploy/
└── docker-compose.yml   # Service orchestration (lite/balanced/pro profiles)

tests/
├── conftest.py          # Shared fixtures
├── test_cli.py          # CLI tests
├── test_config.py       # Config tests
├── test_server.py       # MCP server tests
├── test_storage.py      # Storage tests
└── test_chunking.py     # Chunking tests
```

## Module Guide

### probe/types.py

**Purpose**: Shared Pydantic models for type safety across modules

**Key exports**:
- `ChunkKind` - Enum (CODE, DOC, CONFIG)
- `Chunk` - File chunk with content and location
- `IndexedChunk` - Stored chunk with point_id and hash
- `SearchResult` - Search result with score and signals
- `IndexStatus` - Index health status
- `WorkspaceConfig` - Workspace UUID and settings

**Dependencies**: None (foundation module)

---

### probe/config.py

**Purpose**: Configuration management for workspace and runtime settings

**Key exports**:
- `ProbeConfig` - Runtime config from environment
- `get_repo_id()` - Extract repo ID from git remote
- `init_workspace()` - Create new workspace
- `load_workspace_config()` - Load from .probe/config.json

**Dependencies**: types.py

---

### probe/chunking/

**Purpose**: Convert source files into semantic chunks

**Strategy**:
1. Tree-sitter AST parsing (functions, classes)
2. Markdown heading-based chunks
3. Line-based fallback with overlap

**Key exports**:
- `chunk_file(content, path)` - Main entry point
- `SUPPORTED_LANGUAGES` - Set of supported languages

**Dependencies**: types.py

---

### probe/storage/

**Purpose**: Persistence layer for vectors and metadata

**Components**:
- `QdrantClient` - Vector database with hybrid search + glob filtering
- `Manifest` - SQLite for file tracking and staleness

**Key patterns**:
- Preset-specific collections (chunks_lite, chunks_balanced, chunks_pro)
- BM25 with `language="none"` for code
- UUIDv5 point IDs from position (not content)
- Post-filter glob matching via fnmatch

**Dependencies**: types.py

---

### probe/retrieval.py

**Purpose**: Search pipeline orchestrating dense, sparse, fusion, and reranking

**Flow**:
1. Embed query with instruction prefix (Qwen3 optimization)
2. Hybrid search (dense + BM25 with RRF fusion)
3. Generate snippets from disk
4. Optional rerank (quality mode)

**Key exports**:
- `search()` - Main search function
- `embed_query()` - Get query embedding
- `rerank()` - Rerank documents

**Dependencies**: config.py, storage/, types.py

---

### probe/indexing.py

**Purpose**: Index pipeline from file scanning to vector storage

**Flow**:
1. Scan files (respecting .gitignore patterns)
2. Check staleness via mtime/size
3. Chunk with tree-sitter or fallback
4. Embed via TEI
5. Store in Qdrant + manifest

**Key exports**:
- `run_scan()` - Full incremental scan
- `index_file()` - Index single file

**Dependencies**: chunking/, config.py, storage/, types.py

---

### probe/server.py

**Purpose**: MCP server implementation

**Tools**:
- `search` - Semantic code search (wired to retrieval pipeline)
- `open_file` - Read file with sandbox validation
- `index_status` - Health status (stub)

**Key patterns**:
- stdio transport for MCP
- Global project root state
- Symlink resolution for security

**Dependencies**: config.py, retrieval.py, storage/, types.py

---

### services/reranker/

**Purpose**: Cross-encoder reranking microservice

**Models supported**:
- Qwen3-Reranker-0.6B (LM-style yes/no scoring) - balanced profile
- zerank-2 (sentence-transformers cross-encoder) - pro profile

**Security**: Binds to 127.0.0.1 by default (Docker overrides to 0.0.0.0 for port mapping)

**Dependencies**: FastAPI, transformers, torch

## Data Flow

### Search Flow

```mermaid
sequenceDiagram
    participant AI as AI Assistant
    participant MCP as MCP Server
    participant Ret as Retrieval
    participant TEI as TEI Service
    participant Qdrant as Qdrant
    participant Disk as Disk
    participant Rerank as Reranker

    AI->>MCP: search(query)
    MCP->>Ret: search()
    Ret->>TEI: embed_query()
    TEI-->>Ret: vector
    Ret->>Qdrant: hybrid_search(vector, query)
    Qdrant-->>Ret: candidates (30)
    Ret->>Disk: generate_snippets()
    Disk-->>Ret: snippets + staleness
    Ret->>Rerank: rerank(query, snippets)
    Rerank-->>Ret: scores
    Ret-->>MCP: SearchResult[]
    MCP-->>AI: results
```

### Indexing Flow

```mermaid
sequenceDiagram
    participant CLI as CLI
    participant Idx as Indexing
    participant Manifest as SQLite
    participant Chunk as Chunking
    participant TEI as TEI Service
    participant Qdrant as Qdrant

    CLI->>Idx: run_scan()
    loop Each file
        Idx->>Manifest: check mtime/size
        alt File changed
            Idx->>Chunk: chunk_file()
            Chunk-->>Idx: Chunk[]
            Idx->>TEI: embed_texts()
            TEI-->>Idx: vectors
            Idx->>Qdrant: upsert_chunk()
            Idx->>Manifest: upsert_file/chunks()
        end
    end
```

## Conventions

**Naming**:
- snake_case for functions and variables
- PascalCase for classes
- Constants in UPPER_CASE

**Error Handling**:
- Silent fallback for non-critical failures (rerank, binary files)
- Raise for configuration errors
- Return error text in MCP responses

**Line Numbers**:
- 1-indexed in external APIs
- 0-indexed internally (Python convention)

**Paths**:
- Path objects throughout
- Converted to strings only for JSON serialization

## Gotchas

**Point IDs are position-based**: UUIDv5 computed from workspace_id + file_path + line_range. Content changes don't change the ID, but line shifts do.

**BM25 uses no stemming**: `language="none"` is intentional for code search where `user` != `users`.

**Rerank failures are silent**: Falls back to fusion order on any exception.

**stdout is MCP protocol**: All logging must go to stderr when running serve.

**Preset affects collection**: Switching presets requires full reindex (different dimensions).

**Snippets read from disk**: Always fresh, staleness detected via chunk_hash comparison.

**Glob filters are post-applied**: Qdrant doesn't support glob matching, so include_globs/exclude_globs filter results after vector search.

## Navigation Guide

**To add a new MCP tool**:
1. Add to `list_tools()` in [probe/server.py](probe/server.py)
2. Add handler function `handle_<tool_name>()`
3. Add case to `call_tool()` dispatcher

**To add a new CLI command**:
1. Add function with `@app.command()` in [probe/cli.py](probe/cli.py)
2. Add test in [tests/test_cli.py](tests/test_cli.py)

**To support a new language for chunking**:
1. Add to `SUPPORTED_LANGUAGES` in [probe/chunking/tree_sitter.py](probe/chunking/tree_sitter.py)
2. Add semantic node types to `SEMANTIC_NODES`
3. Test with sample file

**To add a new preset**:
1. Add to `PRESET_CONFIG` in [probe/storage/qdrant.py](probe/storage/qdrant.py)
2. Add TEI service in [deploy/docker-compose.yml](deploy/docker-compose.yml)
3. Update CLI help text

## Health Summary

### Test Coverage Gaps

| Module | Issue | Priority |
|--------|-------|----------|
| probe/retrieval.py | No test file | High |
| probe/indexing.py | No test file | High |
| probe/storage/qdrant.py | No test file | Medium |
| services/reranker/ | No tests | Medium |

### Incomplete Features

From TODO comments and stubs:
- `probe prune` - Stub (not implemented)
- `probe doctor` - Stub (not implemented)
- `serve --watch` - Watch mode not implemented
- `handle_index_status` - Returns hardcoded stub

### Tech Debt

| Location | Issue |
|----------|-------|
| probe/cli.py | TODOs for prune/doctor commands |
| probe/server.py | TODO for index_status implementation |
| probe/storage/qdrant.py | TODO for tracking individual dense/bm25 ranks |

**TODO Distribution**: 10 total across codebase

### Unused Code Candidates

| File/Export | Confidence | Evidence |
|-------------|------------|----------|
| `get_neighbor_chunks()` | High | Manifest method with no callers |
| `set/get_workspace_meta()` | High | Manifest methods with no callers |
| `health_check()` | Medium | QdrantClient method not called |

### Dependency Health

No circular dependencies. Clean unidirectional graph:
```
types.py (foundation)
    ↓
config.py, chunking/, storage/
    ↓
indexing.py, retrieval.py
    ↓
server.py
    ↓
cli.py
```

### Complexity Observations

**Functions approaching complexity threshold**:
- `retrieval.py:search()` - 89 lines, handles mode selection + embedding + search + snippets + reranking
- `indexing.py:index_file()` - 85 lines, handles mtime check + hashing + chunking + embedding + storage
- `chunking/tree_sitter.py:chunk_with_tree_sitter()` - 76 lines, handles parsing + header extraction + traversal + splitting

**Duplicate patterns worth monitoring**:
- Path validation/resolution in server.py and indexing.py
- Chunk hash computation in indexing.py and retrieval.py

## Suggested First Actions

1. **Add retrieval tests** - Core search functionality has no test coverage.

2. **Add indexing tests** - Indexing pipeline has no test coverage.

3. **Implement index_status** - `probe/server.py:handle_index_status` returns hardcoded stub. Wire to manifest/qdrant.

4. **Implement prune command** - `probe prune` marked as stub.

5. **Implement doctor command** - `probe doctor` marked as stub for health checks.
